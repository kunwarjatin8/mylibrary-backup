<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Library</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:linear-gradient(135deg,#f4b183,#e68a7c);min-height:100vh;padding-bottom:80px;}
header{padding:30px 20px 60px;color:white;}
.card{background:rgba(255,255,255,0.95);margin:-40px 15px 15px;padding:20px;border-radius:25px;box-shadow:0 15px 30px rgba(0,0,0,0.15);}
input{width:100%;padding:10px;margin:6px 0;border:none;border-radius:12px;background:#f1f1f1;}
button{padding:10px 14px;border:none;border-radius:12px;background:#4e8da5;color:white;font-weight:600;cursor:pointer;}
nav{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);width:90%;background:white;border-radius:30px;display:flex;justify-content:space-around;padding:12px 0;box-shadow:0 10px 25px rgba(0,0,0,0.2);}
nav button{background:none;color:#333;width:auto;}
nav button.active{color:#e68a7c;}
.hidden{display:none;}
</style>
</head>

<body>

<header>
  <h1>HI JATIN :)</h1>
  <p>Your personal Library</p>
</header>

<div id="home" class="card">
  <h3>Total Books</h3>
  <p><span id="totalCount">0</span></p>
</div>

<div id="add" class="card hidden">
  <h3>Add Book</h3>

  <!-- COVER -->
  <h4>Book Cover</h4>
  <input type="file" id="coverUpload" accept="image/*">
  <img id="coverPreview" style="margin-top:10px;width:120px;border-radius:12px;" alt="Book cover preview">

  <input type="text" id="title" placeholder="Title">

  <input list="authorList" id="author" placeholder="Author">
  <datalist id="authorList"></datalist>

  <input type="number" id="pages" placeholder="Pages">

  <input list="languageList" id="language" placeholder="Language">
  <datalist id="languageList"></datalist>

  <input list="publisherList" id="publisher" placeholder="Publisher">
  <datalist id="publisherList"></datalist>

  <select id="seriesOption" onchange="toggleSeries()">
    <option value="No">Is part of series? No</option>
    <option value="Yes">Yes</option>
  </select>
  <input list="seriesList" id="seriesName" placeholder="Series Name" class="hidden">
  <datalist id="seriesList"></datalist>

  <h4>Purchase Log</h4>

  <input type="date" id="purchaseDate">

  <input list="purchaseList" id="purchaseFrom" placeholder="Purchase From">
  <datalist id="purchaseList"></datalist>

  <input type="number" id="price" placeholder="Price">

  <button style="width:100%;margin-top:8px;" onclick="addBook()">Save Book</button>
</div>

<div id="library" class="card hidden">
  <h3>My Library</h3>
  <div id="bookList"></div>
</div>

<div id="myzone" class="card hidden">
  <h2 style="font-size:22px;margin-bottom:10px;">Backup and Restore</h2>

  <!-- CONNECT BUTTON / PROFILE BOX WRAPPER -->
  <div id="profileBox">
    <button id="connectBtn" onclick="initGoogle()" style="margin-bottom:15px;width:100%;">
      Connect Google
    </button>

    <!-- PROFILE INFO (HIDDEN UNTIL LOGIN) -->
    <div id="profilePopup" style="display:none;margin-bottom:15px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
        <div>
          <div id="profileEmail" style="font-weight:600;"></div>
          <div onclick="logout()" style="color:#4e8da5;cursor:pointer;font-size:14px;margin-top:4px;">
            Log out
          </div>
        </div>
        <img id="profilePic" style="width:60px;height:60px;border-radius:50%;object-fit:cover;" alt="Profile picture">
      </div>

      <!-- DRIVE STORAGE -->
      <div style="margin-bottom:20px;">
        <div style="height:6px;background:#eee;border-radius:10px;overflow:hidden;">
          <div id="driveUsageBar" style="height:100%;width:0%;background:#e68a7c;"></div>
        </div>
        <p id="driveUsageText" style="font-size:13px;margin-top:6px;color:#555;"></p>
      </div>
    </div>
  </div>

  <p style="color:#777;margin-bottom:20px;">Securely back up to the cloud.</p>

  <!-- MAKE BACKUP -->
  <div onclick="createBackup()" 
       style="background:#f4b183;padding:15px;border-radius:15px;color:white;font-weight:600;text-align:center;cursor:pointer;margin-bottom:15px;">
    Make a Backup
  </div>

  <!-- RESTORE LATEST -->
  <div onclick="restoreLatestBackup()" 
       style="background:#4e8da5;padding:15px;border-radius:15px;color:white;font-weight:600;text-align:center;cursor:pointer;margin-bottom:15px;">
    Restore Latest Backup
  </div>

  <!-- BACKUP LIST -->
  <div id="backupList" style="margin-top:15px;"></div>
</div>

<nav>
  <button onclick="showTab('home',this)" class="active">Home</button>
  <button onclick="showTab('add',this)">Add Books</button>
  <button onclick="showTab('library',this)">Library</button>
  <button onclick="showTab('myzone',this)">My Zone</button>
</nav>

<script>
let books = [];
let currentBookId = null;

function showTab(id,btn){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function displayBooks(){
  const list = document.getElementById("bookList");
  if(!list) return;

  list.innerHTML = "";

  books.forEach(function(b){
    list.innerHTML += 
'<div onclick="openBook(\'' + b.id + '\')" ' +
'style="margin:10px 0;padding:10px;background:white;border-radius:15px;cursor:pointer;">' +
'<strong>' + b.title + '</strong><br>' +
(b.author || "") +
'</div>';
  });
}

function addBook(){
  const titleInput = document.getElementById("title");
  const authorInput = document.getElementById("author");

  let book = {
    id: Date.now().toString(),
    title: titleInput.value.trim(),
    author: authorInput.value.trim()
  };

  if(!book.title || !book.author){
    alert("Title & Author required");
    return;
  }

  books.push(book);
  displayBooks();
  document.getElementById("totalCount").innerText = books.length;

  titleInput.value = "";
  authorInput.value = "";

  alert("Book Added");
}

function openBook(id){
  const book = books.find(function(b){ return b.id === id; });
  if(!book) return;

  currentBookId = id;

  document.getElementById("modalTitle").innerText = book.title;
  document.getElementById("modalAuthor").innerText = "Author: " + book.author;
  document.getElementById("bookModal").style.display = "flex";
}

function closeModal(){
  document.getElementById("bookModal").style.display = "none";
}

function deleteBook(){
  if(!confirm("Delete this book?")) return;

  books = books.filter(function(b){
    return b.id !== currentBookId;
  });

  displayBooks();
  document.getElementById("totalCount").innerText = books.length;
  closeModal();
}

function editBook(){
  const book = books.find(function(b){
    return b.id === currentBookId;
  });

  if(!book) return;

  document.getElementById("title").value = book.title;
  document.getElementById("author").value = book.author;

  closeModal();
  showTab('add', document.querySelectorAll('nav button')[1]);
}

function toggleSeries(){
  const opt = document.getElementById("seriesOption").value;
  const sName = document.getElementById("seriesName");
  if(opt === "Yes"){
    sName.classList.remove("hidden");
  } else {
    sName.classList.add("hidden");
  }
}

displayBooks();
</script>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
const CLIENT_ID = "813786394900-v0362a01ak5hsnq4ohuauk55kll5pu0i.apps.googleusercontent.com";

let accessToken = null;
let currentUserEmail = null;
let tokenClient;

window.onload = function(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      sessionStorage.setItem("drive_token", accessToken);
      onLoginSuccess();
    },
  });

  const saved = sessionStorage.getItem("drive_token");
  if(saved){
    accessToken = saved;
    onLoginSuccess();
  }
};

function initGoogle(){
  if(!tokenClient){
    alert("Google not ready. Refresh page.");
    return;
  }
  tokenClient.requestAccessToken();
}

async function onLoginSuccess(){
  document.getElementById("connectBtn").style.display="none";
  document.getElementById("profilePopup").style.display="block";
  await loadUserProfile();
  await loadBackups();
  await loadDriveUsage();
}

async function loadUserProfile(){
  const res = await fetch(
    "https://www.googleapis.com/oauth2/v2/userinfo",
    { headers:{ Authorization:"Bearer "+accessToken } }
  );

  const user = await res.json();

  document.getElementById("profileEmail").innerText = user.email;
  currentUserEmail = user.email;

  if(user.picture){
    document.getElementById("profilePic").src = user.picture;
  }
}

async function loadDriveUsage(){
  const res = await fetch(
    "https://www.googleapis.com/drive/v3/about?fields=storageQuota",
    { headers:{ Authorization:"Bearer "+accessToken } }
  );

  const data = await res.json();

  const used = Number(data.storageQuota.usage);
  const total = Number(data.storageQuota.limit);

  const usedMB = (used/1024/1024).toFixed(2);
  const totalGB = (total/1024/1024/1024).toFixed(2);

  const percent = (used/total)*100;

  document.getElementById("driveUsageBar").style.width = percent + "%";
  document.getElementById("driveUsageText").innerText =
    usedMB + " MB / " + totalGB + " GB";
}

function toggleProfile(){
  const pop = document.getElementById("profilePopup");
  pop.style.display = (pop.style.display==="none" || pop.style.display==="") ? "block" : "none";
}

function logout(){
  sessionStorage.removeItem("drive_token");
  location.reload();
}

async function createBackup(){
  if(!accessToken){
    alert("Login First");
    return;
  }

  document.getElementById("loaderText").innerText = "Creating Backup!! Be Patience ....";
  document.getElementById("loaderModal").style.display = "flex";

  // delete all old backups first
  const old = await fetch(
    "https://www.googleapis.com/drive/v3/files?q=name contains 'library_backup_'&fields=files(id,name)",
    { headers:{ Authorization:"Bearer "+accessToken } }
  );

  const oldData = await old.json();

  if(oldData.files){
    for(const f of oldData.files){
      await fetch(
        "https://www.googleapis.com/drive/v3/files/"+f.id,
        { method:"DELETE", headers:{ Authorization:"Bearer "+accessToken } }
      );
    }
  }

  const fileName = "library_backup_" + Date.now() + ".json";

  let metadata = { name: fileName, mimeType: "application/json" };

  let file = new Blob(
    [JSON.stringify({books: books}, null, 2)],
    { type: "application/json" }
  );

  let form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], {type:"application/json"}));
  form.append("file", file);

  await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
    {
      method:"POST",
      headers:{ Authorization:"Bearer "+accessToken },
      body:form
    }
  );

  await loadBackups();
  document.getElementById("loaderText").innerText = "Backup Created Successfully!";

  setTimeout(()=>{
    document.getElementById("loaderModal").style.display = "none";
  },1500);
}

async function loadBackups(){
  if(!accessToken) return;

  const res = await fetch(
    "https://www.googleapis.com/drive/v3/files?q=name contains 'library_backup_'&fields=files(id,name,createdTime)&orderBy=createdTime desc",
    { headers:{ Authorization:"Bearer "+accessToken } }
  );

  const data = await res.json();
  const list = document.getElementById("backupList");
  list.innerHTML="";

  if(!data.files || data.files.length===0){
    list.innerHTML="<p>No backups yet</p>";
    return;
  }

  data.files.forEach(file=>{
    list.innerHTML+=`
    <div style="margin:10px 0;padding:12px;background:#f1f1f1;border-radius:15px;">
      <strong>${file.name}</strong><br>
      ${new Date(file.createdTime).toLocaleString()}<br>
      <button onclick="restoreBackup('${file.id}')">Restore</button>
      <button onclick="deleteBackup('${file.id}')">Delete</button>
    </div>
    `;
  });
}

async function deleteBackup(id){
  if(!confirm("Are you sure you want to delete this backup?")) return;

  await fetch(
    "https://www.googleapis.com/drive/v3/files/"+id,
    { method:"DELETE", headers:{ Authorization:"Bearer "+accessToken } }
  );

  await loadBackups();
}

async function restoreBackup(fileId){
  if(!accessToken){
    alert("Login First");
    return;
  }

  if(!confirm("This will replace your current library. Continue?")) return;

  const res = await fetch(
    "https://www.googleapis.com/drive/v3/files/"+fileId+"?alt=media",
    { headers:{ Authorization:"Bearer "+accessToken } }
  );

  const data = await res.json();

  if(data.books && Array.isArray(data.books)){
    books = data.books;
    displayBooks();
    document.getElementById("totalCount").innerText = books.length;
    alert("Backup Restored Successfully");

    if(currentUserEmail){
      localStorage.setItem(
        "library_" + currentUserEmail,
        JSON.stringify(books)
      );
    }
  }else{
    alert("Invalid Backup File");
  }
}

async function restoreLatestBackup(){
  if(!accessToken){
    alert("Login First");
    return;
  }

  if(!confirm("This will replace your current library with the latest backup. Continue?")){
    return;
  }

  document.getElementById("loaderText").innerText =
    "Restoring... Please wait";

  document.getElementById("loaderModal").style.display = "flex";

  const search = await fetch(
    "https://www.googleapis.com/drive/v3/files?q=name contains 'library_backup_'&fields=files(id,name,createdTime)&orderBy=createdTime desc&pageSize=1",
    {
      headers:{ Authorization:"Bearer "+accessToken }
    }
  );

  const result = await search.json();

  if(!result.files || result.files.length === 0){
    document.getElementById("loaderModal").style.display="none";
    alert("No backup found in Drive.");
    return;
  }

  const latestFile = result.files[0];

  const fileRes = await fetch(
    "https://www.googleapis.com/drive/v3/files/" + latestFile.id + "?alt=media",
    {
      headers:{ Authorization:"Bearer "+accessToken }
    }
  );

  const data = await fileRes.json();

  if(data.books && Array.isArray(data.books)){
    books = data.books;

    displayBooks();
    document.getElementById("totalCount").innerText = books.length;
    document.getElementById("loaderText").innerText =
      "YAAH!! Restoration Complete! Enjoy your books ðŸ“š";

    setTimeout(()=>{
      document.getElementById("loaderModal").style.display = "none";
    },2000);

    if(currentUserEmail){
      localStorage.setItem(
        "library_" + currentUserEmail,
        JSON.stringify(books)
      );
    }

    alert("Latest Backup Restored Successfully");
  } else {
    document.getElementById("loaderModal").style.display = "none";
    alert("Backup file is invalid.");
  }
}
</script>

<!-- BOOK MODAL -->
<div id="bookModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:15px;width:90%;max-width:400px;">
    <h3 id="modalTitle"></h3>
    <p id="modalAuthor"></p>
    <div style="display:flex;justify-content:space-between;margin-top:15px;">
      <button onclick="editBook()">Modify</button>
      <button onclick="deleteBook()">Delete</button>
    </div>
    <button style="margin-top:10px;" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- LOADER MODAL -->
<div id="loaderModal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
     background:rgba(0,0,0,0.5);justify-content:center;align-items:center;
     color:white;font-size:18px;z-index:9999;">
  <div id="loaderText">Processing...</div>
</div>

</body>
</html>
